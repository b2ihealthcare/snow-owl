= SNOMED CT Extension management

== Introduction
Snow Owl is capable of managing multiple SNOMED CT extensions on a single server. This document highlights how each extension is managed in a dedicated area and lists the main authoring scenarios.  Similarly to generic SNOMED CT authoring, content is developed via the help of a workflow where the work performed on a task is promoted to the repository after review.  Promoting (donating) content from an extension to the international content or between extensions is not supported.  Extension authors can follow their own release schedule and extension content can be versioned at any time during the authoring process. Extensions are based on a single international release version. The base international release can be upgraded ‘underneath’ the extension content. Extensions do not have an additional isolated area for long running development projects (project branch). The import and export of standard RF2 serialized content is supported.
The international content is not edited on the server, only updated via delta releases as consecutive releases are available from IHTSDO’s own authoring process. Search will be performed for both the native language and English as is currently supported. There will be no special search features to accommodate specific language requirements, such as word decompoundization.

image::snomed_extensions.png[role="text-center"]

== Branching arrangement
The implemented branching arrangement closely follows the current branching preferences where the international release is imported onto the MAIN branch and each Member country will have a dedicated branch for the extension content.  The only commits on the MAIN branch are the contents of the delta release for a particular version. These commit points are versioned during the import process. The dedicated branch will be forked off the MAIN branch at the point representing the base international release as shown in Figure 1.

image::extension_authoring.png[role="text-center"]

== Versioning
The extension content is marked with a version tag for future reference with a new empty branch. All new components will receive an effective time.

== Upgrading/Downgrading
Upgrading means to increase the version of the base international release. During the upgrade process, the current extension branch is forward-rebased via creating a new branch and copying over the entire content as a single commit. As shown in Figure 3, the V1 and V2 versioned content is based on the 2016.01.01, whereas the V3 version is based on the 2016.06.01 version of the international release. The main advantage is that the old branch still maintains the earlier versions of the extension, this way the version dependencies between the extension and international release can be implicitly represented via the branches. If the user decides to switch back to the read-only older V1 version, content is properly displayed with international content from 2016.01.01. To avoid content with incorrect dependencies, only versioned extensions should be allowed to be upgraded. Downgrading means to decrease the version of the base international release. The same process described above for upgrade applies.

== International version update
When new international release is available, the corresponding delta is imported onto the MAIN branch.

== Data provisioning example for a single extension
The following example demonstrates how a blank server is provisioned for extension management.  The example is carried out using both the command line OSGi interface as well as the REST API.

=== OSGi command line interface
First, the full International Release is imported with version tags created (_-v_).  The selected language refset is English.

....
> sctimport rf2_release -t full -v /path/to/SnomedCT_RF2Release_INT_20160131.zip /path/to/snomed_ct_international.json
....

Where the `snomed_ct_international.json` release descriptor file is:

[source,json]
----
{
  "name": "Systematized Nomenclature of Medicine Clinical Terms International Version",
  "shortName": "SNOMEDCT",
  "language": "ENG",
  "codeSystemOID": "2.16.840.1.113883.6.96",
  "baseCodeSystemOID": "2.16.840.1.113883.6.96",
  "maintainingOrganizationLink": "http://www.ihtsdo.org",
  "releaseType": "INTERNATIONAL",
  "citation": "SNOMED CT contributes to the improvement of patient care by underpinning the development of Electronic Health Records that record clinical information in ways that enable meaning-based retrieval. This provides effective access to information required for decision support and consistent reporting and analysis. Patients benefit from the use of SNOMED CT because it improves the recording of EHR information and facilitates better communication, leading to improvements in the quality of care."
}
----

After the import process, to check the terminology registry issue the command:

....
> terminologyregistry listall
....

To see all the version branches created execute:

....
> snowowl listbranches snomedStore
....

To import an extension terminology based on the _2016-01-31_ International release, issue the command:

....
> sctimport rf2_release -t full -b 2016-01-31 -v /path/to/SnomedCT_Extension_Release.zip /path/to/snomed_ct_extension.json
....

Where the `snomed_ct_extension.json` release descriptor file is:

[source,json]
----
{
  "name": "B2i Healthcare SNOMED CT extension",
  "shortName": "SNOMEDCT_B2i",
  "language": "ENG",
  "codeSystemOID": "2.16.840.1.113883.6.961",
  "baseCodeSystemOID": "2.16.840.1.113883.6.96",
  "maintainingOrganizationLink": "http://www.b2i.sg",
  "releaseType": "EXTENSION",
  "citation": "This is an example SNOMED CT extension by B2i Healthcare."
}
----

Again, after the import process, to check the terminology registry issue the command:

....
> terminologyregistry listall
....

To see all the version branches created execute:

....
> snowowl listbranches snomedStore
....

There should be a branch named _MAIN/2016-01-31/SNOMEDCT_B2i_ dedicated for the initial content of the extension.

=== REST API
Importing the terminology and creating an entry in the terminology registry require two separate REST endpoints to be invoked.

Upload the import configuration:
....
POST /snowowl/snomed-ct/v2/imports
{
  "createVersions": true,
  "type": "FULL",
  "branchPath": "MAIN",
  "snomedReleaseShortName": ""
}
....

Note: For backward compatibility, missing or empty _snomedReleaseShortName_ result in a SNOMED CT International Release entry in the terminology registry, no explicit operation is required.

Import the International archive:
....
POST /snowowl/snomed-ct/v2/imports/{importId}/archive
....

After the import process, check the terminology registry for the entry representing the International release:
....
GET /snowowl/admin/codesystems
....

Create new branch for extension:
....
POST /snowowl/snomed-ct/v2/branches
{
  "metadata": {},
  "parent": "MAIN/2016-01-31",
  "name": "Extension_branch"
}
....
To check the branch created (_MAIN/2016-01-31/Extension_branch_):
....
GET /snowowl/snomed-ct/v2/branches
....

Create new Snomed Release for the extension. The extension will initially be based on the _2016-01-13_ International release:
....
POST /snowowl/admin/codesystems
{
	"oid": "2.16.840.1.113883.6.961",
	"name": "B2i Healthcare SNOMED CT extension",
	"shortName": "SNOMEDCT_B2i",
	"organizationLink": "http://www.b2i.sg",
	"primaryLanguage": "ENG",
	"citation": "This is an example SNOMED CT extension by B2i Healthcare.",
	"iconPath": "icons/b2i_extension_icon.png",
	"terminologyId": "com.b2international.snowowl.terminology.snomed",
	"repositoryUuid": "snomedStore",
	"branchPath": "MAIN/2016-01-31/Extension_branch",
	"additionalProperties": {
		"baseCodeSystemOID": "2.16.840.1.113883.6.96",
		"snomedReleaseType": "EXTENSION"
	}
}
....

Check the terminology registry for the extension entry:
....
GET /snowowl/admin/codesystems
....

Upload import configuration for extension import:
....
POST /snowowl/snomed-ct/v2/imports
{
  "createVersions": true,
  "type": "DELTA",
  "branchPath": "MAIN/2016-01-31/Extension_branch",
  "snomedReleaseShortName": "SNOMEDCT_B2i"
}
....

Import the extension:
....
POST /snowowl/snomed-ct/v2/imports/{importId}/archive
....

=== Versioning extension content
There is no command line command available for versioning, the functionality is only accessible via the REST interface:
....
POST /snowowl/admin/codesystems/SNOMEDCT_B2i/versions
{
  "version": "Extension:2016-06-01",
  "description": "Extension test version",
  "effectiveDate": "20160601"
}
....
